{"id":"agent-chat-xff","title":"XMPP Agent Chat Service","description":"","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-16T10:00:23.974185-05:00","updated_at":"2025-12-16T10:38:34.264139-05:00","closed_at":"2025-12-16T10:38:34.264139-05:00"}
{"id":"agent-chat-xff.1","title":"Project setup and configuration","description":"Initialize the Bun TypeScript project with proper dependencies and configuration.\n\n## Install Dependencies\nUse bun add to get the latest versions:\n```bash\n# Runtime dependencies\nbun add @xmpp/client @xmpp/debug @modelcontextprotocol/sdk\n\n# Dev dependencies\nbun add -d @types/bun typescript\n```\n\n## Tasks\n1. Run bun init if not already initialized\n2. Install dependencies using bun add (commands above)\n3. Configure tsconfig.json for Bun/TypeScript\n4. Set up directory structure as per spec:\n```\nsrc/\n├── index.ts              # Entry point\n├── config.ts             # Configuration loading\n├── xmpp/\n├── agents/\n├── mcp/\n├── messages/\n└── state/\n```\n5. Create Config interface in src/config.ts supporting:\n   - XMPP server settings (host, port, domain, admin creds)\n   - Manager bot credentials\n   - MCP server settings (port, permission timeout)\n   - Work directory base path\n   - Agent limits (maxConcurrent, idleTimeout)\n6. Support loading from ~/.agent-chat/config.json or env vars","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:00:34.652916-05:00","updated_at":"2025-12-16T10:23:11.019161-05:00","closed_at":"2025-12-16T10:23:11.019161-05:00","dependencies":[{"issue_id":"agent-chat-xff.1","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:00:34.655068-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.10","title":"MCP HTTP server","description":"Create src/mcp/server.ts - HTTP/SSE MCP server for permission prompts.\n\n## Architecture\nSingle HTTP server that all Claude Code agents connect to:\n- Runs in main process\n- Default port: 3001\n- SSE transport for MCP\n\n## Endpoints\n- `/mcp` - SSE endpoint for MCP connections\n\n## Agent Identification\nEach Claude Code process connects with X-Agent-ID header (set in their MCP config).\nUse this to route tool calls to the correct agent.\n\n## Implementation\nUse @modelcontextprotocol/sdk for MCP server implementation with SSE transport.\n\n```typescript\ninterface MCPServer {\n  start(port: number): Promise\u003cvoid\u003e;\n  stop(): Promise\u003cvoid\u003e;\n  \n  // Register a tool handler\n  registerTool(name: string, handler: ToolHandler): void;\n}\n```\n\n## Connection Tracking\n- Track active connections by agent ID\n- Handle reconnections gracefully\n- Clean up when agent disconnects\n\n## Integration\n- Exposes tools registered via registerTool()\n- Routes tool calls to appropriate handlers based on tool name\n- Extracts agent ID from X-Agent-ID header for routing","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:02:31.665321-05:00","updated_at":"2025-12-16T10:27:12.358147-05:00","closed_at":"2025-12-16T10:27:12.358147-05:00","dependencies":[{"issue_id":"agent-chat-xff.10","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:02:31.665952-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.10","depends_on_id":"agent-chat-xff.1","type":"blocks","created_at":"2025-12-16T10:06:23.729946-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.11","title":"Permission prompt MCP tool","description":"Create src/mcp/tools/permission-prompt.ts - MCP tool for permission requests.\n\n## Tool Schema\n```typescript\n{\n  name: 'permission_prompt',\n  description: 'Request permission from the user for an action',\n  inputSchema: {\n    type: 'object',\n    properties: {\n      action: { type: 'string' },        // 'bash_command', 'edit_file', etc.\n      description: { type: 'string' },   // Human-readable description\n      details: { type: 'object' }        // Action-specific details\n    },\n    required: ['action', 'description']\n  }\n}\n```\n\n## Implementation Flow\n1. Claude calls permission_prompt via HTTP\n2. Extract agent ID from X-Agent-ID header\n3. Look up agent in registry → find XMPP JID\n4. Generate unique request ID (e.g., 'perm-a1b2c3')\n5. Format as human-readable message with ID\n6. Send via agent's XMPP connection\n7. Store pending request: { id, agentId, resolve, reject, timeout }\n8. Wait for user response (configurable timeout, default 5 min)\n9. Return { approved: true/false, reason?: string } to Claude\n\n## Permission Message Format\n```\nPermission #a1b2:\n  Action: Run bash command\n  Command: npm install lodash\n  Reply: yes/no (or 'a1b2 yes')\n```\n\n## Multiple Concurrent Permissions\n- Each permission gets unique ID displayed to user\n- Response routing:\n  - Reply to agent chat → matches that agent's oldest pending permission\n  - Include ID (e.g., 'a1b2 yes') → matches by ID\n  - Ambiguous → resolve oldest pending for that agent\n\n## Timeout Handling\n- Default: 5 minutes (configurable via config.mcp.permissionTimeout)\n- On timeout: return { approved: false, reason: 'timeout' }\n- Remove from pending map\n\n## Dependencies\n- MCP Server (registers this tool)\n- Agent Registry (to look up agent by ID)\n- XMPP connections (to send messages)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:02:46.38991-05:00","updated_at":"2025-12-16T10:36:22.445778-05:00","closed_at":"2025-12-16T10:36:22.445778-05:00","dependencies":[{"issue_id":"agent-chat-xff.11","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:02:46.391697-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.11","depends_on_id":"agent-chat-xff.10","type":"blocks","created_at":"2025-12-16T10:06:28.212105-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.11","depends_on_id":"agent-chat-xff.12","type":"blocks","created_at":"2025-12-16T10:06:29.78953-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.11","depends_on_id":"agent-chat-xff.4","type":"blocks","created_at":"2025-12-16T10:06:31.813616-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.12","title":"MCP request router","description":"Create src/mcp/router.ts - routes MCP tool calls to correct agent.\n\n## Purpose\nWhen a tool call comes in via MCP, route it to the correct agent based on the X-Agent-ID header.\n\n## Implementation\n```typescript\ninterface MCPRouter {\n  // Register a handler for an agent\n  registerAgent(agentId: string, handler: AgentHandler): void;\n  \n  // Unregister when agent disconnects\n  unregisterAgent(agentId: string): void;\n  \n  // Route a tool call to the appropriate agent\n  route(agentId: string, toolCall: ToolCall): Promise\u003cToolResult\u003e;\n}\n\ninterface AgentHandler {\n  // Handle permission prompts for this agent\n  handlePermission(request: PermissionRequest): Promise\u003cPermissionResult\u003e;\n}\n```\n\n## Responsibilities\n- Maintain map of agent ID → handler\n- Extract agent ID from incoming requests\n- Route tool calls to correct handler\n- Handle unknown agent IDs gracefully (return error)\n\n## Integration\n- Used by MCP Server to dispatch tool calls\n- AgentXMPPHandler registers as handler for each agent\n- Permission tool uses router to find correct agent","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T10:03:03.649105-05:00","updated_at":"2025-12-16T10:29:19.583517-05:00","closed_at":"2025-12-16T10:29:19.583517-05:00","dependencies":[{"issue_id":"agent-chat-xff.12","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:03:03.650621-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.12","depends_on_id":"agent-chat-xff.10","type":"blocks","created_at":"2025-12-16T10:06:25.828047-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.13","title":"Message parsing and formatting","description":"Create src/messages/ module for parsing and formatting messages.\n\n## Files\n- src/messages/parser.ts - Parse incoming messages\n- src/messages/formatter.ts - Format outgoing messages\n- src/messages/structured.ts - Structured message types\n\n## Parser (parser.ts)\nParse user input to detect:\n- Permission responses: 'yes', 'no', 'y', 'n', or with ID like 'a1b2 yes'\n- Reserved commands: 'quit', 'status', 'help'\n- Regular messages (pass through to agent)\n\n```typescript\ntype ParsedMessage =\n  | { type: 'permission_response'; permissionId?: string; approved: boolean }\n  | { type: 'command'; command: 'quit' | 'status' | 'help' }\n  | { type: 'message'; content: string };\n\nfunction parseMessage(text: string): ParsedMessage;\n```\n\n## Formatter (formatter.ts)\nFormat outgoing messages for XMPP:\n- Plain text messages\n- Permission request prompts\n- Status updates\n- Error messages\n\n```typescript\nfunction formatPermissionPrompt(request: PermissionRequest, id: string): string;\nfunction formatStatus(agent: Agent): string;\nfunction formatError(error: Error): string;\n```\n\n## Structured Types (structured.ts)\nDefine TypeScript types for structured data:\n- Claude Code JSON events (init, assistant, result)\n- Permission requests/responses\n- Agent status\n\n## Notes\n- Keep formatting simple and readable for mobile XMPP clients\n- Use plain text, avoid complex markup\n- Permission prompts should be scannable at a glance","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T10:04:02.766093-05:00","updated_at":"2025-12-16T10:27:12.434221-05:00","closed_at":"2025-12-16T10:27:12.434221-05:00","dependencies":[{"issue_id":"agent-chat-xff.13","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:04:02.767954-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.13","depends_on_id":"agent-chat-xff.1","type":"blocks","created_at":"2025-12-16T10:06:54.785473-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.14","title":"Service entry point","description":"Create src/index.ts - main entry point that starts all services.\n\n## Startup Sequence\n1. Load configuration from ~/.agent-chat/config.json or env vars\n2. Load persisted state from ~/.agent-chat/state.json\n3. Mark all agents as 'stopped' (processes don't survive restart)\n4. Start MCP HTTP server on configured port\n5. Connect manager bot to XMPP\n6. Register permission_prompt tool with MCP server\n7. Log startup complete message\n\n## Example Output\n```\n[2024-01-15 10:30:00] Agent Chat Service starting...\n[2024-01-15 10:30:01] Connected to XMPP server at chat.example.com\n[2024-01-15 10:30:01] Manager bot online: manager@chat.example.com\n[2024-01-15 10:30:01] MCP server listening on port 3001\n[2024-01-15 10:30:01] Listening for messages...\n```\n\n## Graceful Shutdown\nHandle SIGINT/SIGTERM:\n1. Stop accepting new agents\n2. Send shutdown notice to active agents' chats\n3. Kill all agent processes\n4. Disconnect from XMPP\n5. Save final state\n6. Exit\n\n## Error Handling\n- If XMPP connection fails: retry with backoff, log errors\n- If state file corrupt: start fresh, warn user\n- If MCP server fails to start: exit with error (critical)\n\n## Dependencies\nThis ties together all other modules:\n- config.ts\n- state/persistence.ts\n- xmpp/client.ts\n- xmpp/manager-bot.ts\n- mcp/server.ts\n- agents/registry.ts","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:04:16.320471-05:00","updated_at":"2025-12-16T10:38:07.613829-05:00","closed_at":"2025-12-16T10:38:07.613829-05:00","dependencies":[{"issue_id":"agent-chat-xff.14","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:04:16.321926-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.14","depends_on_id":"agent-chat-xff.8","type":"blocks","created_at":"2025-12-16T10:07:20.054688-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.14","depends_on_id":"agent-chat-xff.9","type":"blocks","created_at":"2025-12-16T10:07:29.576548-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.14","depends_on_id":"agent-chat-xff.11","type":"blocks","created_at":"2025-12-16T10:07:29.752854-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.15","title":"Error handling and logging","description":"Add comprehensive error handling and logging throughout the service.\n\n## Logging\nCreate a simple logging utility that outputs timestamped messages:\n\n```typescript\n// src/utils/logger.ts\nfunction log(level: 'info' | 'warn' | 'error', message: string, meta?: object): void;\n```\n\nFormat: `[YYYY-MM-DD HH:mm:ss] [LEVEL] message`\n\n## Error Categories\n1. **XMPP Errors**\n   - Connection failures → retry with exponential backoff\n   - Message send failures → queue for retry\n   - Authentication errors → log and exit\n\n2. **Agent Process Errors**\n   - Crash → log, notify user, attempt restart with --resume\n   - Spawn failure → log, notify user via manager bot\n   - Timeout → log warning\n\n3. **MCP Errors**\n   - Server start failure → exit (critical)\n   - Tool call errors → return error to Claude\n\n4. **State Errors**\n   - Load failure → start fresh, warn\n   - Save failure → log error, continue (in-memory state still valid)\n\n## User Notifications\nWhen errors affect user experience, notify via XMPP:\n- 'Agent process crashed, attempting restart...'\n- 'Could not connect to XMPP server, retrying...'\n- 'Permission request timed out'\n\n## Security Logging\nLog all permission grants for auditing:\n`[2024-01-15 10:30:00] [SECURITY] Permission granted: agent=swift-fox action=bash_command command='npm install'`\n\n## Implementation\n- Add try/catch blocks around all async operations\n- Use error boundaries at service boundaries\n- Never crash the main process for agent-level errors","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T10:04:29.431833-05:00","updated_at":"2025-12-16T10:27:12.507582-05:00","closed_at":"2025-12-16T10:27:12.507582-05:00","dependencies":[{"issue_id":"agent-chat-xff.15","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:04:29.433243-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.15","depends_on_id":"agent-chat-xff.1","type":"blocks","created_at":"2025-12-16T10:07:40.008459-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.16","title":"Reconnection and recovery logic","description":"Implement reconnection and recovery logic for resilient operation.\n\n## XMPP Reconnection\nWhen XMPP connection drops:\n1. Queue outbound messages\n2. Attempt reconnect with exponential backoff (1s, 2s, 4s, 8s, max 60s)\n3. On reconnect, flush queued messages\n4. Re-establish presence\n\nUse XEP-0198 Stream Management for:\n- Resuming sessions without re-auth\n- Guaranteed message delivery\n- Detecting connection loss quickly\n\n## Agent Process Recovery\nWhen a Claude Code process exits unexpectedly:\n1. Log the exit with reason/code\n2. Check if sessionId is available from last result event\n3. If yes: respawn with `--resume \u003csessionId\u003e`\n4. If no: start fresh session\n5. Notify user: 'Agent restarted' or 'Agent crashed, starting fresh'\n\n```typescript\nasync function recoverAgent(agent: Agent): Promise\u003cvoid\u003e {\n  if (agent.sessionId) {\n    // Respawn with resume\n    await spawnWithResume(agent.sessionId);\n  } else {\n    // Fresh start\n    await spawnFresh();\n  }\n}\n```\n\n## Message Queue During Disconnects\n```typescript\nclass MessageQueue {\n  private queue: Array\u003c{ to: string; message: string; timestamp: Date }\u003e = [];\n  private maxSize = 100;\n  private maxAge = 5 * 60 * 1000; // 5 minutes\n  \n  enqueue(to: string, message: string): void;\n  flush(sender: (to: string, msg: string) =\u003e Promise\u003cvoid\u003e): Promise\u003cvoid\u003e;\n  prune(): void; // Remove old messages\n}\n```\n\n## State Recovery on Restart\nOn service restart:\n1. All agent processes are gone (they don't persist)\n2. Load state file\n3. Mark all agents as 'stopped'\n4. User must manually respawn agents (future: auto-respawn option)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T10:04:43.433394-05:00","updated_at":"2025-12-16T10:36:22.522282-05:00","closed_at":"2025-12-16T10:36:22.522282-05:00","dependencies":[{"issue_id":"agent-chat-xff.16","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:04:43.43507-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.16","depends_on_id":"agent-chat-xff.2","type":"blocks","created_at":"2025-12-16T10:07:42.161518-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.16","depends_on_id":"agent-chat-xff.6","type":"blocks","created_at":"2025-12-16T10:07:42.328723-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.2","title":"XMPP client wrapper","description":"Create src/xmpp/client.ts - a reusable XMPP client wrapper using @xmpp/client.\n\n## Requirements\n- Use `@xmpp/client` library for XMPP connections\n- Support XEP-0198 Stream Management for connection reliability\n- Support XEP-0359 Unique Stanza IDs for deduplication\n- Support XEP-0085 Chat State Notifications (typing indicators)\n- Always use TLS for connections\n\n## Interface Design\n```typescript\ninterface XMPPClientConfig {\n  host: string;\n  port: number;\n  domain: string;\n  username: string;\n  password: string;\n}\n\nclass XMPPClient {\n  connect(): Promise\u003cvoid\u003e;\n  disconnect(): Promise\u003cvoid\u003e;\n  sendMessage(to: string, body: string): Promise\u003cvoid\u003e;\n  sendTypingIndicator(to: string): void;\n  onMessage(handler: (from: string, body: string) =\u003e void): void;\n  // Handle disconnects gracefully - queue outbound messages during brief disconnects\n}\n```\n\n## Key Behaviors\n- Auto-reconnect on connection loss\n- Queue outbound messages during disconnects\n- Emit events for incoming messages\n- Handle presence management","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:00:43.629917-05:00","updated_at":"2025-12-16T10:27:21.249796-05:00","closed_at":"2025-12-16T10:27:21.249796-05:00","dependencies":[{"issue_id":"agent-chat-xff.2","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:00:43.630981-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.2","depends_on_id":"agent-chat-xff.1","type":"blocks","created_at":"2025-12-16T10:05:08.573613-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.3","title":"State persistence","description":"Create src/state/persistence.ts - handles persisting service state to disk.\n\n## State Location\n~/.agent-chat/state.json\n\n## Data Model\n```typescript\ninterface Agent {\n  id: string;              // e.g., 'swift-fox'\n  type: AgentType;         // 'claude-code' | ...\n  jid: string;             // XMPP JID: 'swift-fox@domain'\n  workDir: string;         // '/home/user/work/my-project'\n  createdAt: Date;\n  createdBy: string;       // Your JID\n  status: 'starting' | 'running' | 'stopping' | 'stopped';\n  pid?: number;            // OS process ID\n  sessionId?: string;      // Claude Code session ID (for --resume)\n}\n\ninterface ServiceState {\n  agents: Agent[];\n  config: {\n    workBasePath: string;  // e.g., '/home/user/work'\n    xmppDomain: string;\n    managerJid: string;\n  };\n}\n```\n\n## Requirements\n1. Load state on startup\n2. Save state after any agent changes\n3. Handle missing/corrupted state file gracefully (start fresh)\n4. On service restart:\n   - Load persisted registry\n   - Mark ALL agents as status: 'stopped' (processes are gone)\n   - Agents need to be respawned manually by user\n\n## Note\nPasswords for agents are NOT persisted (can be regenerated). The sessionId IS persisted to enable future '--resume' functionality after crashes.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:00:55.440419-05:00","updated_at":"2025-12-16T10:27:00.59216-05:00","closed_at":"2025-12-16T10:27:00.59216-05:00","dependencies":[{"issue_id":"agent-chat-xff.3","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:00:55.442537-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.3","depends_on_id":"agent-chat-xff.1","type":"blocks","created_at":"2025-12-16T10:05:13.091178-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.4","title":"Agent registry","description":"Create src/agents/registry.ts - tracks active agents and their metadata.\n\n## Responsibilities\n- Track all active agents in memory\n- Map XMPP JIDs to agent processes\n- Generate unique agent IDs using [adjective]-[animal] format\n- Persist state changes via the persistence module\n\n## Agent ID Generation\nUse adjective-animal format for memorable names:\n\n**Adjectives:** swift, clever, bold, calm, eager, gentle, happy, keen, lucky, mighty, noble, quick, sharp, wise, brave, bright, cool, fair, grand, jolly\n\n**Animals:** fox, owl, bear, wolf, hawk, deer, lynx, seal, crow, dove, hare, lion, otter, panda, raven, tiger, viper, whale, zebra, badger\n\nExamples: swift-fox, clever-owl, bold-bear\n\nOn collision (ID already exists), retry with new random selection.\n\n## Interface\n```typescript\nclass AgentRegistry {\n  // Get all agents\n  getAll(): Agent[];\n  \n  // Get agent by ID\n  get(id: string): Agent | undefined;\n  \n  // Get agent by JID\n  getByJid(jid: string): Agent | undefined;\n  \n  // Register new agent\n  register(agent: Omit\u003cAgent, 'id' | 'createdAt'\u003e): Agent;\n  \n  // Update agent status/metadata\n  update(id: string, updates: Partial\u003cAgent\u003e): void;\n  \n  // Remove agent from registry\n  remove(id: string): void;\n  \n  // Generate unique agent ID\n  generateId(): string;\n}\n```\n\n## Dependencies\n- Depends on state persistence module for loading/saving","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:01:18.743538-05:00","updated_at":"2025-12-16T10:29:19.379362-05:00","closed_at":"2025-12-16T10:29:19.379362-05:00","dependencies":[{"issue_id":"agent-chat-xff.4","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:01:18.74515-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.4","depends_on_id":"agent-chat-xff.3","type":"blocks","created_at":"2025-12-16T10:05:26.346344-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.5","title":"Agent adapter interface","description":"Create src/agents/adapter.ts - pluggable interface for different agent types.\n\n## Interface Definition\n```typescript\ninterface AgentAdapter {\n  /** Unique identifier for this agent type */\n  readonly type: string;\n\n  /** Display name */\n  readonly displayName: string;\n\n  /** Spawn a new agent process */\n  spawn(config: AgentConfig): Promise\u003cAgentProcess\u003e;\n}\n\ninterface AgentConfig {\n  workDir: string;        // Repo directory\n  initialPrompt?: string; // Initial task\n}\n\ninterface AgentProcess {\n  /** Send a message to the agent */\n  send(message: string): void;\n\n  /** Stream of output chunks from agent */\n  output: AsyncIterable\u003cOutputChunk\u003e;\n\n  /** Kill the agent process */\n  kill(): Promise\u003cvoid\u003e;\n\n  /** Check if process is still running */\n  readonly isAlive: boolean;\n}\n\ntype OutputChunk =\n  | { type: 'text'; content: string }\n  | { type: 'structured'; data: StructuredMessage };\n```\n\n## Purpose\nThis interface allows plugging in different AI coding agents:\n- Claude Code (primary, implemented in separate task)\n- Future: Codex, Aider, other LLM-based tools\n\nEach adapter handles:\n- Process spawning\n- Input/output streaming\n- Structured input handling\n\n## Notes\n- The adapter abstracts away the differences between agent CLIs\n- Output is an AsyncIterable for streaming support\n- The send() method queues messages for when agent is ready","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:01:31.349499-05:00","updated_at":"2025-12-16T10:25:14.271493-05:00","closed_at":"2025-12-16T10:25:14.271493-05:00","dependencies":[{"issue_id":"agent-chat-xff.5","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:01:31.351561-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.5","depends_on_id":"agent-chat-xff.1","type":"blocks","created_at":"2025-12-16T10:05:16.024885-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.6","title":"Claude Code adapter","description":"Create src/agents/claude-code.ts - implements AgentAdapter for Claude Code.\n\n## Process Spawning\nUse Bun's spawn() with Claude Code's headless mode:\n\n```typescript\nconst args = [\n  'claude', '-p',\n  '--output-format', 'stream-json',\n  '--input-format', 'stream-json',\n  '--permission-prompt-tool', 'mcp__agent_chat__permission_prompt',\n  '--mcp-config', mcpConfigPath\n];\n\nif (sessionId) args.push('--resume', sessionId);\n\nconst proc = Bun.spawn(args, {\n  cwd: workDir,\n  stdin: 'pipe',\n  stdout: 'pipe',\n  stderr: 'pipe'\n});\n```\n\n## MCP Config Generation\nGenerate per-agent MCP config at /tmp/agent-chat-{agent-id}-mcp.json:\n```json\n{\n  \"mcpServers\": {\n    \"agent_chat\": {\n      \"type\": \"sse\",\n      \"url\": \"http://localhost:3001/mcp\",\n      \"headers\": {\n        \"X-Agent-ID\": \"\u003cagent-id\u003e\"\n      }\n    }\n  }\n}\n```\n\n## Input Format (stdin)\nSend user messages as JSONL:\n```typescript\nproc.stdin.write(JSON.stringify({\n  type: 'user',\n  message: { role: 'user', content: [{ type: 'text', text: userMessage }] }\n}) + '\\n');\n```\n\n## Output Processing (stdout)\n- Read stdout line by line (JSONL format)\n- Parse each line as JSON event (init, assistant messages, result)\n- Forward complete assistant messages to output AsyncIterable\n- Persist session_id from each result event for crash recovery\n\n## Crash Recovery\nIf process exits unexpectedly:\n1. Respawn with '--resume \u003csession_id\u003e' from last result event\n2. If no session_id available, start fresh and notify user\n\n## Message Queueing\n- Queue messages received while Claude is processing\n- Flush queue when Claude emits result event\n- Notify user if queue grows large: 'Message queued, agent is busy...'\n\n## Key Flags\n- --output-format stream-json: JSONL on stdout\n- --input-format stream-json: JSONL on stdin (keeps process alive)\n- --permission-prompt-tool: Routes permissions through MCP","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:01:47.750097-05:00","updated_at":"2025-12-16T10:29:32.648318-05:00","closed_at":"2025-12-16T10:29:32.648318-05:00","dependencies":[{"issue_id":"agent-chat-xff.6","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:01:47.752315-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.6","depends_on_id":"agent-chat-xff.5","type":"blocks","created_at":"2025-12-16T10:05:28.51504-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.7","title":"XMPP user management","description":"Implement XMPP user creation/deletion for agents via Prosody's mod_admin_rest.\n\n## API Endpoints\nProsody's mod_admin_rest provides:\n- `POST /admin/user/{jid}` - create user\n- `DELETE /admin/user/{jid}` - delete user\n\n## Implementation Location\nAdd to src/xmpp/admin.ts\n\n## Interface\n```typescript\ninterface XMPPAdmin {\n  // Create a new XMPP user for an agent\n  createUser(username: string, password: string): Promise\u003cvoid\u003e;\n  \n  // Delete an XMPP user when agent is destroyed\n  deleteUser(username: string): Promise\u003cvoid\u003e;\n}\n```\n\n## Password Generation\n- Agent passwords can be simple/random since server is on trusted network\n- Generate at agent creation time\n- NOT persisted (regenerated on restart if needed)\n\n## Usage\n- Called by AgentRegistry when registering new agent\n- Called when destroying/removing an agent\n- Manager bot user ('manager@domain') is pre-created, not managed here\n\n## Error Handling\n- Handle user already exists (ignore or retry with different name)\n- Handle network errors to Prosody\n- Log failures for debugging","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:01:58.179444-05:00","updated_at":"2025-12-16T10:29:19.509522-05:00","closed_at":"2025-12-16T10:29:19.509522-05:00","dependencies":[{"issue_id":"agent-chat-xff.7","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:01:58.181261-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.7","depends_on_id":"agent-chat-xff.2","type":"blocks","created_at":"2025-12-16T10:05:30.938813-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.8","title":"Manager bot","description":"Create src/xmpp/manager-bot.ts - the manager bot that handles agent lifecycle.\n\n## XMPP Identity\n- Fixed user: manager@domain\n- Always online when service is running\n\n## Commands\n| Command | Description |\n|---------|-------------|\n| `new` / `new agent` / `create` | Start agent creation flow |\n| `list` / `agents` | List all active agents |\n| `kill \u003cagent-id\u003e` | Force-kill an agent |\n| `status \u003cagent-id\u003e` | Get agent status |\n| `repos` | List available repositories |\n| `help` | Show available commands |\n\n## Agent Creation Flow (Conversational)\n```\nUser: 'new agent'\nManager: 'What type of agent? [1] Claude Code [2] Codex'\nUser: '1'\nManager: 'Available repos: [1] my-project [2] another-repo [3] third-repo'\nUser: '1'\nManager: 'What\\'s the initial task for the agent?'\nUser: 'Fix the login bug'\nManager: '✓ Agent swift-fox created. Chat at swift-fox@domain'\n```\n\n## Implementation Details\n- Use XMPPClient wrapper for connection\n- Maintain conversation state per user (for multi-step flows)\n- List repos by scanning config.work.basePath for directories\n- Coordinate with AgentRegistry for agent creation\n- Coordinate with XMPPAdmin for user creation\n\n## Dependencies\n- XMPPClient (for messaging)\n- AgentRegistry (for agent management)\n- XMPPAdmin (for creating agent XMPP users)\n- Config (for repo paths)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:02:11.220188-05:00","updated_at":"2025-12-16T10:36:22.287738-05:00","closed_at":"2025-12-16T10:36:22.287738-05:00","dependencies":[{"issue_id":"agent-chat-xff.8","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:02:11.221454-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.8","depends_on_id":"agent-chat-xff.2","type":"blocks","created_at":"2025-12-16T10:05:49.342635-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.8","depends_on_id":"agent-chat-xff.4","type":"blocks","created_at":"2025-12-16T10:05:51.556127-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.8","depends_on_id":"agent-chat-xff.7","type":"blocks","created_at":"2025-12-16T10:05:54.121834-05:00","created_by":"daemon"}]}
{"id":"agent-chat-xff.9","title":"Agent XMPP handler","description":"Create src/xmpp/agent-bot.ts - per-agent XMPP message handler.\n\n## Purpose\nBridges XMPP messages to/from agent processes.\n\n## Message Flow\n1. **User → Agent**: XMPP message → queue → write to agent stdin when ready\n2. **Agent → User**: Agent stdout → parse → send as XMPP messages\n\n## Reserved Commands\nThese commands are intercepted BEFORE reaching the agent:\n- `quit` - Shuts down the agent\n- `status` - Returns agent status\n- `help` - Shows help for agent chat\n\n## Output Streaming\n- Read agent output (AsyncIterable\u003cOutputChunk\u003e)\n- Forward text chunks as XMPP messages\n- Handle structured data appropriately\n- Send typing indicator (\u003ccomposing/\u003e) when agent is working\n\n## Message Limits (prevent flooding)\n- Max message size: 64KB (Prosody default stanza limit)\n- Rate limit: Max 10 messages/second per agent\n- If rate exceeded, queue and warn user\n\n## Shutdown Flow\nWhen user sends 'quit':\n1. Intercept (don't send to Claude)\n2. Send 'Shutting down...' message\n3. Call agent.kill()\n4. Delete XMPP user\n5. Remove from registry\n6. Notify manager bot to inform user\n\n## Interface\n```typescript\nclass AgentXMPPHandler {\n  constructor(\n    agent: Agent,\n    agentProcess: AgentProcess,\n    xmppClient: XMPPClient,\n    registry: AgentRegistry\n  );\n  \n  // Start handling messages for this agent\n  start(): void;\n  \n  // Stop and cleanup\n  stop(): Promise\u003cvoid\u003e;\n}\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-16T10:02:22.817226-05:00","updated_at":"2025-12-16T10:36:22.373273-05:00","closed_at":"2025-12-16T10:36:22.373273-05:00","dependencies":[{"issue_id":"agent-chat-xff.9","depends_on_id":"agent-chat-xff","type":"parent-child","created_at":"2025-12-16T10:02:22.818868-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.9","depends_on_id":"agent-chat-xff.2","type":"blocks","created_at":"2025-12-16T10:06:02.760195-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.9","depends_on_id":"agent-chat-xff.4","type":"blocks","created_at":"2025-12-16T10:06:06.863185-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.9","depends_on_id":"agent-chat-xff.6","type":"blocks","created_at":"2025-12-16T10:06:09.373476-05:00","created_by":"daemon"},{"issue_id":"agent-chat-xff.9","depends_on_id":"agent-chat-xff.13","type":"blocks","created_at":"2025-12-16T10:06:12.680348-05:00","created_by":"daemon"}]}
